@using Student_Performance_Management_System.ViewModel
@model StaffDashViewModel

@{
    var today = DateTime.Now;

    // Dynamic Academic Session (e.g., 2025-26)
    int startYear = today.Month >= 6 ? today.Year : today.Year - 1;
    string dynamicSession = $"{startYear}-{(startYear + 1) % 100}";

    var dashboardTasks = Model.Tasks
        .OrderBy(t => t.Status == Status.Completed)
        .ThenBy(t => t.ValidTo)
        .Take(6)
        .ToList();

    Layout = "_StaffLayout";
}

<div class="container-fluid py-4 animate-fade-in">

    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm rounded-4 p-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">

                    <!-- Profile Block -->
                    <div class="staff-welcome">
                        <img src="@Model.Profile"
                             class="rounded-circle profile-img"
                             alt="Profile Photo">
                        <div class="col-md-9">
                            <h5 class="mb-2">@Model.StaffName</h5>
                            <p class="mb-1"><strong>Email: </strong>@Model.Email</p>
                            <p class="mb-3"><strong>Mobile: </strong> @Model.MobileNo</p>

                            <a href="/Staff/EditProfile/@Model.StaffId" class="btn btn-primary btn-sm">
                                Edit Profile
                            </a>
                        </div>
                    </div>

                    <!-- Date & Session -->
                    <div class="text-end d-none d-md-block">
                        <div class="h6 fw-bold text-primary mb-1">
                            @today.ToString("dd MMM yyyy")
                        </div>
                        <span class="badge bg-primary-subtle text-primary rounded-pill">
                            Academic Session @dynamicSession
                        </span>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">

        <div class="col-12 col-sm-6 col-xl-3">
            <div class="card border-0 shadow-sm rounded-4 p-3 h-100">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-primary-subtle text-primary rounded-3 me-3">
                        <i class="bi bi-journal-text fs-4"></i>
                    </div>
                    <div>
                        <small class="text-muted">Total Tasks</small>
                        <h4 class="fw-bold mb-0">@Model.TaskCount</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
            <div class="card border-0 shadow-sm rounded-4 p-3 h-100">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-danger-subtle text-danger rounded-3 me-3">
                        <i class="bi bi-exclamation-circle fs-4"></i>
                    </div>
                    <div>
                        <small class="text-muted">Pending / Overdue</small>
                        <h4 class="fw-bold mb-0">
                            @Model.Tasks.Count(t => t.Status != Status.Completed)
                        </h4>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Priority Tasks -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">

        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center py-3">
            <h5 class="fw-bold mb-0">
                <i class="bi bi-lightning-charge text-warning me-2"></i>
                Priority Action Items
            </h5>
            <a href="/Staff/MyTasks" class="btn btn-sm btn-outline-primary rounded-pill">
                View All Tasks
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">

                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Subject & Course</th>
                        <th>Status</th>
                        <th style="width: 240px;">Deadline</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var task in dashboardTasks)
                    {
                        var totalTime = (task.ValidTo - task.ValidFrom).TotalSeconds;
                        var timeUsed = (today - task.ValidFrom).TotalSeconds;
                        var percent = totalTime > 0
                        ? Math.Min(100, Math.Max(0, (timeUsed / totalTime) * 100))
                        : 0;

                        string barColor = percent > 80
                        ? "bg-danger"
                        : percent > 50
                        ? "bg-warning"
                        : "bg-primary";

                        <tr>
                            <td class="ps-4">
                                <div class="fw-semibold">@task.Subject.SubjectName</div>
                                <div class="small text-muted">
                                    @task.Course.CourseName •
                                    <span class="fw-semibold">@task.CourseGroup.GroupName</span>
                                </div>
                            </td>

                            <td>
                                @switch (task.Status)
                                {
                                    case Status.Pending:
                                        <span class="badge bg-warning-subtle text-warning rounded-pill">Pending</span>
                                        break;
                                    case Status.Completed:
                                        <span class="badge bg-success-subtle text-success rounded-pill">Completed</span>
                                        break;
                                    case Status.Overdue:
                                        <span class="badge bg-danger-subtle text-danger rounded-pill">Overdue</span>
                                        break;
                                }
                            </td>

                            <td>
                                <small class="text-muted d-block mb-1">
                                    Exp: @task.ValidTo.ToString("dd MMM")
                                </small>
                                <div class="progress">
                                    <div class="progress-bar @(task.Status == Status.Completed ? "bg-success" : barColor)"
                                         style="width:@(task.Status == Status.Completed ? "100" : percent)%">
                                    </div>
                                </div>
                            </td>

                            <td class="text-center">
                                <div class="btn-group gap-2">

                                    @if (task.Status == Status.Pending)
                                    {
                                        <a href="/Staff/AddMark/@task.TasksId"
                                           class="btn btn-sm btn-primary rounded-pill">
                                            Add Marks
                                        </a>
                                    }
                                    else if (task.Status == Status.Overdue)
                                    {
                                        <a asp-action="SendLateRequest"
                                           asp-route-id="@task.TasksId"
                                           class="btn btn-sm btn-outline-danger rounded-pill">
                                            Request Extension
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary rounded-pill">
                                            Locked
                                        </span>
                                    }

                                </div>
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>
    </div>
</div>

<style>
    .profile-img {
        width: 110px;
        height: 110px;
        object-fit: cover;
        border: 3px solid #e9ecef;
    }

    .staff-welcome {
        display: flex;
        align-items: center;
        gap: 1.25rem;
    }

    .staff-meta h5 {
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .staff-meta p {
        margin-bottom: 0;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .stats-icon {
        width: 52px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .progress {
        height: 6px;
        border-radius: 10px;
        background-color: #e9ecef;
        overflow: hidden;
    }

    .progress-bar {
        transition: width 0.4s ease;
    }

    .btn-group {
        justify-content: center;
        flex-wrap: wrap;
    }
</style>
